name: Deploy

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Auth GCP
        uses: google-github-actions/auth@v2
        with:
          credentials_json: '${{ secrets.GCP_SA_KEY }}'
          project_id: 'ingestaokraken'
      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
      - name: Warm-up wait before deployment
        run: |
          echo "Waiting 30 seconds before deployment to reduce 409 queue conflicts..."
          sleep 30
      - name: Deploy Functions
        run: |
          set +e

          REGION="us-central1"
          MAX_ATTEMPTS=5
          RETRY_WAIT=90
          EXIT_CODE=1

          is_queue_conflict() {
            local message="$1"
            if [[ "$message" == *"status=[409]"* ]] && [[ "$message" == *"unable to queue the operation"* ]]; then
              return 0
            fi
            return 1
          }

          for attempt in $(seq 1 "$MAX_ATTEMPTS"); do
            echo "Starting deployment attempt $attempt/$MAX_ATTEMPTS for get_stock_data"
            DEPLOY_OUTPUT=$(gcloud functions deploy get_stock_data \
              --runtime python311 \
              --trigger-http \
              --entry-point get_stock_data \
              --source functions/get_stock_data \
              --allow-unauthenticated \
              --project ingestaokraken \
              --region "$REGION" \
              --quiet 2>&1)
            EXIT_CODE=$?
            echo "$DEPLOY_OUTPUT"

            if [ "$EXIT_CODE" -eq 0 ]; then
              echo "Deployment succeeded on attempt $attempt."
              break
            fi

            if [ "$attempt" -lt "$MAX_ATTEMPTS" ]; then
              if is_queue_conflict "$DEPLOY_OUTPUT"; then
                echo "Deployment attempt $attempt failed with transient queue conflict (409)."
                echo "Waiting $RETRY_WAIT seconds before retrying..."
                sleep "$RETRY_WAIT"
              else
                echo "Detected non-transient deploy error; stopping retries early."
                break
              fi
            else
              echo "Deployment failed after $MAX_ATTEMPTS attempts."
            fi
          done

          if [ "$EXIT_CODE" -ne 0 ]; then
            exit "$EXIT_CODE"
          fi
      - name: Deploy Cloud Run function
        run: |
          gcloud run deploy google-finance-price \
            --source functions/google_finance_price \
            --allow-unauthenticated \
            --project ingestaokraken \
            --region us-central1 \
            --set-env-vars FUNCTION_TARGET=google_finance_price,FUNCTION_SIGNATURE_TYPE=http \
            --quiet

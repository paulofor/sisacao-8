name: Deploy

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Auth GCP
        uses: google-github-actions/auth@v2
        with:
          credentials_json: '${{ secrets.GCP_SA_KEY }}'
          project_id: 'ingestaokraken'
      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
      - name: Wait for pending Cloud Functions operations
        run: |
          REGION="us-central1"
          MAX_ATTEMPTS=20
          SLEEP_SECONDS=30
          PENDING="pending"

          list_pending_operations() {
            local output

            if output=$(gcloud functions operations list \
              --region "$REGION" \
              --filter="done=false" \
              --format="value(name)" 2>/dev/null); then
              printf '%s\n' "$output"
              return 0
            fi

            if output=$(gcloud beta functions operations list \
              --region "$REGION" \
              --filter="done=false" \
              --format="value(name)" 2>/dev/null); then
              printf '%s\n' "$output"
              return 0
            fi

            echo "Failed to list Cloud Functions operations using stable or beta commands." >&2
            return 1
          }

          for attempt in $(seq 1 "$MAX_ATTEMPTS"); do
            if ! PENDING=$(list_pending_operations); then
              exit 1
            fi

            if [ -z "$PENDING" ]; then
              echo "No pending operations found before deployment."
              break
            fi

            echo "Cloud Functions operations still running (attempt $attempt/$MAX_ATTEMPTS):"
            echo "$PENDING"
            echo "Waiting $SLEEP_SECONDS seconds before checking again..."
            sleep "$SLEEP_SECONDS"
          done

          if [ -n "$PENDING" ]; then
            echo "Timed out waiting for Cloud Functions operations to finish."
            exit 1
          fi
      - name: Deploy Functions
        run: |
          set +e

          REGION="us-central1"
          MAX_ATTEMPTS=5
          RETRY_WAIT=90
          EXIT_CODE=1

          list_pending_operations() {
            local output

            if output=$(gcloud functions operations list \
              --region "$REGION" \
              --filter="done=false" \
              --format="value(name)" 2>/dev/null); then
              printf '%s\n' "$output"
              return 0
            fi

            if output=$(gcloud beta functions operations list \
              --region "$REGION" \
              --filter="done=false" \
              --format="value(name)" 2>/dev/null); then
              printf '%s\n' "$output"
              return 0
            fi

            echo "Failed to list Cloud Functions operations using stable or beta commands." >&2
            return 1
          }

          for attempt in $(seq 1 "$MAX_ATTEMPTS"); do
            echo "Starting deployment attempt $attempt/$MAX_ATTEMPTS for get_stock_data"
            gcloud functions deploy get_stock_data \
              --runtime python311 \
              --trigger-http \
              --entry-point get_stock_data \
              --source functions/get_stock_data \
              --allow-unauthenticated \
              --project ingestaokraken \
              --region "$REGION" \
              --quiet
            EXIT_CODE=$?

            if [ "$EXIT_CODE" -eq 0 ]; then
              echo "Deployment succeeded on attempt $attempt."
              break
            fi

            if [ "$attempt" -lt "$MAX_ATTEMPTS" ]; then
              echo "Deployment attempt $attempt failed with exit code $EXIT_CODE."
              echo "Waiting $RETRY_WAIT seconds before retrying..."
              sleep "$RETRY_WAIT"

              echo "Checking for remaining Cloud Functions operations before retrying:"
              if ! PENDING=$(list_pending_operations); then
                exit 1
              fi
              if [ -n "$PENDING" ]; then
                echo "$PENDING"
              else
                echo "No pending operations detected."
              fi
            else
              echo "Deployment failed after $MAX_ATTEMPTS attempts."
            fi
          done

          if [ "$EXIT_CODE" -ne 0 ]; then
            exit "$EXIT_CODE"
          fi
      - name: Deploy Cloud Run function
        run: |
          gcloud run deploy google-finance-price \
            --source functions/google_finance_price \
            --allow-unauthenticated \
            --project ingestaokraken \
            --region us-central1 \
            --set-env-vars FUNCTION_TARGET=google_finance_price,FUNCTION_SIGNATURE_TYPE=http \
            --quiet

name: Deploy

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

env:
  PROJECT_ID: ingestaokraken
  REGION: us-central1

jobs:
  deploy-cloud-functions:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      max-parallel: 1
      matrix:
        include:
          - name: get_stock_data
            entry_point: get_stock_data
            source: functions/get_stock_data
            service_account: sa-get-stock-data@ingestaokraken.iam.gserviceaccount.com
            env: BQ_INTRADAY_DATASET=cotacao_intraday,BQ_DAILY_TABLE=cotacao_ohlcv_diario,BQ_HOLIDAYS_TABLE=feriados_b3
          - name: intraday_candles
            entry_point: generate_intraday_candles
            source: functions/intraday_candles
            service_account: sa-intraday-candles@ingestaokraken.iam.gserviceaccount.com
            env: BQ_INTRADAY_DATASET=cotacao_intraday,BQ_INTRADAY_RAW_TABLE=cotacao_b3,BQ_INTRADAY_15M_TABLE=candles_intraday_15m,BQ_INTRADAY_1H_TABLE=candles_intraday_1h
          - name: eod_signals
            entry_point: generate_eod_signals
            source: functions/eod_signals
            service_account: sa-eod-signals@ingestaokraken.iam.gserviceaccount.com
            env: BQ_INTRADAY_DATASET=cotacao_intraday,BQ_DAILY_TABLE=cotacao_ohlcv_diario,BQ_SIGNALS_TABLE=sinais_eod,BQ_HOLIDAYS_TABLE=feriados_b3,BQ_BACKTEST_METRICS_TABLE=backtest_metrics
          - name: backtest_daily
            entry_point: backtest_daily
            source: functions/backtest_daily
            service_account: sa-backtest-daily@ingestaokraken.iam.gserviceaccount.com
            env: BQ_INTRADAY_DATASET=cotacao_intraday,BQ_DAILY_TABLE=cotacao_ohlcv_diario,BQ_SIGNALS_TABLE=sinais_eod,BQ_BACKTEST_TRADES_TABLE=backtest_trades,BQ_BACKTEST_METRICS_TABLE=backtest_metrics,BQ_HOLIDAYS_TABLE=feriados_b3
          - name: alerts
            entry_point: alerts
            source: functions/alerts
            service_account: sa-alerts@ingestaokraken.iam.gserviceaccount.com
            env: BQ_INTRADAY_DATASET=cotacao_intraday,BQ_SIGNALS_TABLE=sinais_eod
          - name: dq_checks
            entry_point: dq_checks
            source: functions/dq_checks
            service_account: sa-dq-checks@ingestaokraken.iam.gserviceaccount.com
            env: BQ_INTRADAY_DATASET=cotacao_intraday,BQ_DAILY_TABLE=cotacao_ohlcv_diario,BQ_INTRADAY_RAW_TABLE=cotacao_b3,BQ_SIGNALS_TABLE=sinais_eod,BQ_BACKTEST_METRICS_TABLE=backtest_metrics,BQ_HOLIDAYS_TABLE=feriados_b3,BQ_DQ_CHECKS_TABLE=dq_checks_daily,BQ_DQ_INCIDENTS_TABLE=dq_incidents,BQ_TICKERS_TABLE=acao_bovespa
    steps:
      - uses: actions/checkout@v4
      - name: Auth GCP
        uses: google-github-actions/auth@v2
        with:
          credentials_json: '${{ secrets.GCP_SA_KEY }}'
          project_id: '${{ env.PROJECT_ID }}'
      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
      - name: Deploy ${{ matrix.name }}
        run: |
          set -o pipefail

          get_function_state() {
            gcloud functions describe "$1" \
              --project "${PROJECT_ID}" \
              --region "${REGION}" \
              --gen2 \
              --format='value(state)' 2>/dev/null || true
          }

          wait_for_idle_function() {
            local function_name="$1"
            local max_checks=40
            local sleep_seconds=15

            for check in $(seq 1 "${max_checks}"); do
              state=$(get_function_state "${function_name}")

              if [ -z "${state}" ] || [ "${state}" = "ACTIVE" ] || [ "${state}" = "FAILED" ]; then
                echo "Function ${function_name} is in state '${state:-UNKNOWN}'. Continuing deploy."
                return 0
              fi

              if [ "${state}" = "DEPLOYING" ]; then
                waited_seconds=$((check * sleep_seconds))
                echo "Function ${function_name} is DEPLOYING (${check}/${max_checks}). Waiting ${sleep_seconds}s (${waited_seconds}s elapsed)..."
                sleep "${sleep_seconds}"
                continue
              fi

              echo "Function ${function_name} is in state '${state}'. Continuing deploy without extra wait."
              return 0
            done

            echo "Timed out waiting for ${function_name} to leave DEPLOYING state."
            return 1
          }

          wait_for_idle_function "${{ matrix.name }}"

          deploy_cmd=(
            gcloud functions deploy "${{ matrix.name }}"
            --runtime python311
            --trigger-http
            --entry-point "${{ matrix.entry_point }}"
            --source "${{ matrix.source }}"
            --service-account "${{ matrix.service_account }}"
            --project "${PROJECT_ID}"
            --region "${REGION}"
            --set-env-vars="${{ matrix.env }}"
            --quiet
          )

          for attempt in 1 2 3; do
            log_file=$(mktemp)

            set +e
            "${deploy_cmd[@]}" --verbosity=debug --log-http 2>&1 | tee "$log_file"
            status=${PIPESTATUS[0]}
            set -e

            if [ $status -eq 0 ]; then
              rm -f "$log_file"
              break
            fi

            if grep -q "unable to queue the operation" "$log_file" && [ $attempt -lt 3 ]; then
              echo "Deploy returned 409 queue conflict. Waiting until function is no longer DEPLOYING (attempt ${attempt}/3)."
              rm -f "$log_file"

              if ! wait_for_idle_function "${{ matrix.name }}"; then
                echo "Function remained DEPLOYING for too long after queue conflict."
                exit 1
              fi

              continue
            fi

            echo "Deploy command failed with status $status. Last 200 lines of gcloud output:"
            tail -n 200 "$log_file"
            rm -f "$log_file"

            echo "Collecting additional diagnostics for ${{ matrix.name }}..."
            gcloud functions describe "${{ matrix.name }}" \
              --project "${PROJECT_ID}" \
              --region "${REGION}" \
              --gen2 \
              --format=yaml || true

            gcloud run revisions list \
              --project "${PROJECT_ID}" \
              --region "${REGION}" \
              --service "${{ matrix.name }}" \
              --limit=5 || true

            gcloud logging read \
              'resource.type="cloud_run_revision" AND resource.labels.service_name="${{ matrix.name }}"' \
              --project "${PROJECT_ID}" \
              --limit=100 \
              --format="value(timestamp,severity,textPayload,jsonPayload.message)" || true

            exit $status
          done

  deploy-cloud-run:
    runs-on: ubuntu-latest
    needs: deploy-cloud-functions
    steps:
      - uses: actions/checkout@v4
      - name: Auth GCP
        uses: google-github-actions/auth@v2
        with:
          credentials_json: '${{ secrets.GCP_SA_KEY }}'
          project_id: '${{ env.PROJECT_ID }}'
      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
      - name: Deploy google_finance_price
        run: |
          gcloud run deploy google-finance-price \
            --source functions/google_finance_price \
            --project ${PROJECT_ID} \
            --region ${REGION} \
            --service-account sa-google-finance-price@${PROJECT_ID}.iam.gserviceaccount.com \
            --set-env-vars=FUNCTION_TARGET=google_finance_price,FUNCTION_SIGNATURE_TYPE=http,BQ_INTRADAY_DATASET=cotacao_intraday,BQ_INTRADAY_RAW_TABLE=cotacao_b3,BQ_HOLIDAYS_TABLE=feriados_b3 \
            --quiet
